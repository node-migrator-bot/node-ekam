#!/usr/bin/env node

var fs = require('fs')
var path = require('path')

var program = require('commander')
var debug = require('debug')('ekam')
var _eval = require('node-eval')

var packageInfo = require('../package.json')
var Builder = require('..')

var defaultBuild = {
	"input": {
		"include": "**/*.js"
	, "exclude": "build.json build.js"
	}
,	"output": {
		"path": "../build"
	, "mode": "0755"
	, "clean": true
	}
,	"uglify": {
		"mangle": {
			"defines": {
				"DEBUG": [ "name", "false" ]
			}
		}
	,	"squeeze": {
			"make_seqs": true
		,	"dead_code": true
		}
	,	"gen": {
		}
	}
}

program
  .version(packageInfo.version)
  .option(
	  '-b, --build <js or json file>'
	, 'Use the specified build file'
	, path.join( '.', 'build.json' )
	)
	.option(
	  '-i, --init'
	, 'Creates a default sample build file'
	, null
	)
  .parse(process.argv)

function done (err) {
	if (err) return console.error(err)
	debug('Builder DONE.')
}

if (program.init) {
	var defaultBuildString = JSON.stringify(defaultBuild, null, 2)

	debug('creating default build files %s and %s', 'build.json', 'build.js')

	// JSON file
	fs.writeFileSync('build.json', defaultBuildString)

	// JS file
	fs.writeFileSync('build.js', 'build(' + defaultBuildString + ')')

} else if (program.build) {
	var config = program.build
	var configFile = path.resolve( process.cwd(), config )
	var configPath = path.dirname(configFile)

	debug('build file: %s -> %s', config, configFile)
	if ( /\.json$/.test(config) ) {
		Builder(
			require(configFile)
		, configPath
		, done
		)
	} else {
		var sandbox = require('shelljs')

		sandbox.build = function (data, callback) {
				Builder(
					data
				, configPath
				, callback || done
				)
			}
		// Hack to pass the modified String.prototype
		sandbox.__StringPrototype = String.prototype

		_eval(
			'for(var k in __StringPrototype)'
		+ 'String.prototype[k]=__StringPrototype[k];'
		+	'__StringPrototype=undefined;'
		+	fs.readFileSync(config)
		, config
		, sandbox
		)
	}
}
